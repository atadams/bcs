<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>

<body>
	<svg width="960" height="500"></svg>
<p>
	<button onclick="moveCohort('noScreening');">Without Screening</button>
	<button onclick="moveCohort('forties');">Screened in 40s</button>
	<button onclick="moveCohort('fifties');">Screened in 50s</button>
</p>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script>
		var svg = d3.select("svg"),
			width = +svg.attr("width"),
			height = +svg.attr("height");

		var bar = {
			x: d3.scaleBand()
				.range([0, 200])
				.padding(0.1),
			y: d3.scaleLinear()
				.range([height, 0]),
			data: {
				noscreening: {
					falsealarm: 0,
					biopsies: 0,
					cases: 0
				},
				forties: {
					falsealarm: 1529,
					biopsies: 213,
					cases: 154,
					overdiagnoses: 21
				},
				fifties: {
					falsealarm: 953,
					biopsies: 145,
					cases: 154,
					overdiagnoses: 19
				}
			}
			};


		var cohortPositions = [
			{x: 600.779977034962, y: 247.939006403502},
			{x: 594.460598977301, y: 254.729885290262},
			{x: 600.427172806529, y: 239.247510027988},
			{x: 605.447765775399, y: 257.210927322285},
			{x: 587.923583251674, y: 246.140652691528},
			{x: 612.499237611653, y: 244.55914667007},
			{x: 594.744430336824, y: 263.844014348307},
			{x: 592.018250877135, y: 237.994823248871},
			{x: 613.575738043761, y: 253.618719499979},
			{x: 584.880350780036, y: 255.581644052448},
			{x: 607.751491168481, y: 235.525779108654},
			{x: 604.175029376687, y: 266.84772016258},
			{x: 579.51831600069, y: 240.108379695761},
			{x: 622.114889456453, y: 243.734272868036},
			{x: 587.130807468468, y: 268.964514117601},
			{x: 595.550553757415, y: 227.622514438485},
			{x: 617.3736684095, y: 262.795005670144},
			{x: 576.839668105165, y: 249.774796781836},
			{x: 616.922420996243, y: 234.120090509068},
			{x: 597.999305350801, y: 273.850939598086},
			{x: 585.518377831594, y: 231.407568604891},
			{x: 622.993909973629, y: 254.138440079454},
			{x: 579.540638495396, y: 261.876700527518},
			{x: 606.685343719311, y: 227.024400557431},
			{x: 611.962842018049, y: 270.176737443848}
		];

		var cohortGroups = {
			"unaffected": { color: "#ccc" },
			"affected": { color: "hsl(200, 23%, 46%)"},
			"noscreening": { color: "hsl(200, 23%, 46%)" },
			"forties": { color: "#eb494f" },
			"fifties": { color: "#76ff03" },
			"survivor": { color: "hsl(340, 100%, 72%)" }
		};

		var cohortState = "unaffected";

		var nodes = d3.range(1000).map(initCohorts(6));

		initStatus(nodes);

		var g = svg.append("g");

		g.selectAll("circle")
			.data(nodes)
			.enter().append("circle")
			.style("fill", function(d) {
				return cohortGroups["unaffected"].color
			})
			.attr("cx", function(d) {
				return d.x;
			})
			.attr("cy", function(d) {
				return d.y;
			})
			.attr("r", 3.5)
			.attr("id", function(d) {
				return d.id
			});


		function initCohorts(radius) {
			var theta = Math.PI * (3 - Math.sqrt(5));
			return function(i) {
				var r = radius * Math.sqrt(i),
					a = theta * i,
					x = 250 + r * Math.cos(a),
					y = height / 2 + r * Math.sin(a);
				return {
					x: x,
					y: y,
					origX: x,
					origY: y,
					cohort: "unaffected",
					id: "id" + i
				};
			};
		}


		function initStatus(nodes) {
			for (var i = 0; i < 25; i++) {
				var unaffected = nodes.filter(findUnaffected);
				var nodeIdx = Math.floor(Math.random() * unaffected.length);

				unaffected[nodeIdx].cohort = "noscreening";
				unaffected[nodeIdx].positions = {
					"unaffected": {x: unaffected[nodeIdx].x, y: unaffected[nodeIdx].y},
					"fifties": {x: unaffected[nodeIdx].x, y: unaffected[nodeIdx].y},
					"forties": {x: unaffected[nodeIdx].x, y: unaffected[nodeIdx].y}
				};
				unaffected[nodeIdx].color = {
					"unaffected": cohortGroups["survivor"].color,
					"affected": cohortGroups["affected"].color,
					"noScreening": cohortGroups["affected"].color,
					"fifties": cohortGroups["survivor"].color,
					"forties": cohortGroups["survivor"].color
				};

				unaffected[nodeIdx].positions.noScreening = cohortPositions[i];
			}

			for (var i = 0; i < 17; i++) {
				var noscreening = nodes.filter(findNoScreening);
				var randomPos = Math.floor(Math.random() * noscreening.length);
				noscreening[randomPos].cohort = "forties";
				noscreening[randomPos].positions.forties = noscreening[randomPos].positions.noScreening;
				noscreening[randomPos].positions.fifties = noscreening[randomPos].positions.noScreening;
				noscreening[randomPos].color.forties = cohortGroups["affected"].color;
				noscreening[randomPos].color.fifties = cohortGroups["affected"].color;
			}

			noscreening = nodes.filter(findNoScreening);
			randomPos = Math.floor(Math.random() * noscreening.length);
			noscreening[randomPos].cohort = "fifties";
			noscreening[randomPos].positions.fifties = noscreening[randomPos].positions.noScreening;
			noscreening[randomPos].color.fifties = cohortGroups["affected"].color;
		}


		function findUnaffected(nodes) {
			return nodes.cohort === "unaffected";
		}


		function findNoScreening(nodes) {
			return nodes.cohort === "noscreening";
		}


		function findForties(nodes) {
			return nodes.cohort === "forties";
		}


		function findFifties(nodes) {
			return nodes.cohort === "fifties";
		}

		function findCohort(cohort) {
			if (cohort == "forties") {
				return nodes.filter(findForties);
			} else if (cohort == "fifties") {
				return nodes.filter(findForties).concat(nodes.filter(findFifties));
			} else if (cohort == "noScreening") {
				return nodes.filter(findForties).concat(nodes.filter(findFifties)).concat(nodes.filter(findNoScreening));
			}
		}


		function moveCohort(cohort) {
			var cohortNodes = findCohort("noScreening");
			cohortNodes.forEach(function(d) {
				d3.selectAll("circle#" + d.id)
					.transition().duration(2000)
					.style("fill", function(d) {
						return d.color[cohort]
					})
					.attr("cx", d.positions[cohort].x)
					.attr("cy", d.positions[cohort].y);
			});
		}
	</script>
</body>

</html>
